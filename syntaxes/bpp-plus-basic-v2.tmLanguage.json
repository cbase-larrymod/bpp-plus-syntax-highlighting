{
    "name": "Commodore BPP+ BASIC V2",
    "scopeName": "source.bpp+basicv2",

    "patterns": [
        {
            "include": "#keywords_control"
        },
        {
            "include": "#keywords_functions"
        },
        {
            "include": "#user_functions"
        },
        {
            "include": "#keywords_storage"
        },
        {
            "include": "#keywords_io_disk"
        },
        {
            "include": "#operators"
        },
        {
            "include": "#numbers_line"
        },
        {
            "include": "#numbers_numeric"
        },
        {
            "include": "#comments"
        },
        {
            "include": "#include_statements"
        },
        {
            "include": "#strings"
        },
        {
            "include": "#statement_chaining"
        },
        {
            "include": "#labels"
        },
        {
            "include": "#label_subroutine_calls"
        },
        {
            "include": "#variables"
        },
        {
            "include": "#extension_symbols"
        }
     ],

    "repository": {

        "variables": {
            "patterns": [
                {
                    "name": "variable.other",
                    "comment": "BASIC v2 variable names including optional $ or %",
                    "match": "(?i)\\b[A-Z][A-Z0-9]*[\\$%]?"
                }
            ]
        },

        "keywords_control": {
            "patterns": [
                {
                    "name": "keyword.control",
                    "comment": "BASIC v2 control statements",
                    "match": "(?i)\\b(end|for|next|gosub|goto|if|then|step|stop|return|to|on)\\b"
                }
            ]
        },

        "keywords_functions": {
            "patterns": [
                {
                    "name": "support.function",
                    "comment": "BASIC v2 standard functions",
                    "match": "(?i)\\b(abs|asc|atn|chr\\$|cos|exp|int|len|left\\$|mid\\$|peek|pos|rnd|right\\$|sgn|sin|sqr|tan|str\\$|usr|val)\\b"
                }
            ]
        },

        "user_functions": {
            "patterns": [
                {
                    "name": "entity.name.function.user",
                    "comment": "BASIC v2 user-defined FN functions",
                    "match": "(?i)\\b(DEF\\s+FN|FN)\\s+([A-Z][A-Z0-9_]*)\\b",
                    "captures": {
                        "1": {
                            "name": "keyword.control",
                            "comment": "FN keyword"
                        },
                        "2": {
                            "name": "entity.name.function.user",
                            "comment": "User-defined function name"
                        }
                    }
                }
            ]
        },

        "keywords_storage": {
            "patterns": [
                {
                    "name": "storage.modifier",
                    "comment": "BASIC v2 variable declaration keywords",
                    "match": "(?i)\\b(dim|data|let|def)\\b"
                }
            ]
        },

        "keywords_io_disk": {
            "patterns": [
                {
                    "name": "keyword.io",
                    "comment": "BASIC v2 I/O and disk operations",
                    "match": "(?i)\\b(print|print#|input|input#|open|close|load|list|save|restore|read|get|get#|poke|peek|sys|run|verify|wait)\\b"
                }
            ]
        },

        "operators": {
            "patterns": [
                {
                    "name": "keyword.operator",
                    "comment": "BASIC v2 operators",
                    "match": "(?i)(\\*|/|\\+|-|\\^|=|<>|<|>|<=|>=|and|or|not)"
                }
            ]
        },

        "numbers_line": {
            "patterns": [
                {
                    "name": "constant.language",
                    "comment": "BASIC v2 line numbers at the start of a line",
                    "match": "^\\s*(\\d+)"
                }
            ]
        },

        "numbers_numeric": {
            "patterns": [
                {
                    "name": "constant.numeric",
                    "comment": "BASIC v2 numeric constants: decimal, hexadecimal ($...), or binary (%...)",
                    "match": "(\\d+|\\$[0-9a-fA-F]+|%[01]+)"
                }
            ]
        },

        "include_statements": {
            "patterns": [
                    {
                        "name": "meta.include.statement",
                        "comment": "BPP+ include statements with type and file path, e.g., !include source \"../common/file.bpp\" or !include data \"file.bpp\"",
                        "match": "(!include)\\s+(source|data)\\s+\"([^\"]+)\"",
                            "captures": {
                                "1": { "name": "keyword.control.include" },
                                "2": { "name": "storage.type.include" },
                                "3": { "name": "string.quoted.double.include" }
                            }
                    }
            ]
        },

        "labels": {
            "patterns": [
                {
                    "name": "entity.name.function.basic",
                    "comment": "BPP+ labels ending with a colon at start of line, allows letters, digits, and underscores, but skips BASIC keywords like NEXT",
                    "match": "(?i)^\\s*(?!(?:next|return|stop|end)\\s*:)[_A-Za-z][_A-Za-z0-9]*:"
                }
            ]
        },

        "label_subroutine_calls": {
            "patterns": [
                {
                    "name": "entity.name.function",
                    "comment": "BPP+ subroutine names after GOSUB or GOTO, optionally with child using dot; allows spaces after commas",
                    "match": "(?<=\\b(gosub|goto)\\s+)([A-Za-z_][A-Za-z0-9_]*(?:\\.[A-Za-z_][A-Za-z0-9_]*)?)(?:\\s*,\\s*([A-Za-z_][A-Za-z0-9_]*(?:\\.[A-Za-z_][A-Za-z0-9_]*)?))*"
                }
            ]
        },

        "comments": {
            "patterns": [
                {
                    "name": "comment.line",
                    "comment": "BASIC v2 single line comment starting with REM (case-insensitive)",
                    "begin": "(?i)\\s*REM",
                    "end": "$"
                },
                {
                    "name": "comment.line",
                    "comment": "BPP+ single line comment starting with ;",
                    "begin": "^\\s*(;)",
                    "end": "$"
                }
            ]
        },

        "strings": {
            "name": "string.quoted.double",
                "comment": "Double-quoted strings, may include braced tokens (single quotes are treated as normal characters)",
            "begin": "[\"]",
            "end": "[\"]",
            "patterns": [
                {
                    "name": "meta.token.braced",
                    "comment": "Braced tokens inside strings, e.g., {XXX}, {XXX-Z}, {Y XXX-Z}",
                    "begin": "\\{",
                    "end": "\\}",
                    "beginCaptures": {
                        "0": { "name": "support.function.token.braces.begin" }
                    },
                    "endCaptures": {
                        "0": { "name": "support.function.token.braces.end" }
                    },
                    "patterns": [
                        {
                            "name": "constant.numeric.token-count",
                            "comment": "Numeric token inside braces",
                            "match": "\\b\\d+\\b"
                        },
                        {
                            "name": "support.function.token",
                            "comment": "Alphanumeric token including operators -+*^@. inside braces",
                            "match": "[a-zA-Z_][a-zA-Z0-9_\\-+*^@\\.]*"
                        },
                        {
                            "name": "text.whitespace",
                            "comment": "Whitespace inside braced token",
                            "match": "\\s+"
                        }
                    ]
                },
                {
                    "name": "string.character",
                    "comment": "Any other character inside the string",
                    "match": "."
                }
            ]
        },

        "statement_chaining": {
            "patterns": [
                {
                    "name": "invalid.illegal.statement-chaining",
                    "match": "\\\\$",
                    "comment": "Backslash at end of line for BPP+ statement chaining"
                }
            ]
        },

        "extension_symbols": {
            "patterns": [
                {
                    "name": "invalid.illegal.prof-plum-extensions",
                    "comment": "Highlight Prof. Plum’s BASIC symbols like @ and ←",
                    "match": "[@←]"
                }
            ]
        }
    }
}
